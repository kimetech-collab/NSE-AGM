# NSE Portal â€” Technical Documentation

## 1) Purpose and Scope
NSE Portal is a Laravel-based system for managing the NSE AGM lifecycle end-to-end: registration, OTP verification, payment, ticketing (QR), accreditation, attendance tracking, certificate issuance, and role-based administration.

This document is organized around:
- system design and architecture
- implementation details completed so far
- API-by-module route reference

## 2) Technology Stack
- Backend: Laravel (PHP), Eloquent ORM
- Frontend: Blade templates, utility-class styling, Alpine.js interactions
- Auth: Laravel auth + verified middleware + role middleware
- Security Controls: throttling, Paystack signature verification, admin MFA gate
- Documents: DomPDF for ticket and certificate rendering
- Storage: `public` disk for uploaded assets (profile photos, sponsor logos, speaker photos)
- Observability: audit logs for admin and sensitive actions

## 3) Architecture

### 3.1 Layered Design
- Presentation Layer:
  - Blade views for public and admin portals
  - route-level closures for simple content pages
- Application Layer:
  - Controllers handle request validation, flow orchestration, response shaping
- Domain/Service Layer:
  - `RegistrationService`, `PaymentService`, `QRService`, `CertificateService`, `AuditService`
  - `EventDates` support component centralizes timeline logic
- Data Layer:
  - Eloquent models and migrations
  - SQLite/MySQL compatible schema patterns
- Integration Layer:
  - Paystack API for payment initialize/verify/refund/webhook

### 3.2 Runtime Context Diagram
```mermaid
flowchart LR
    U[Participant] --> PUB[Public Routes + Blade]
    A[Admin User] --> ADM[Admin Routes + Blade]

    PUB --> RC[RegistrationController]
    PUB --> PC[PaymentController]
    PUB --> CC[CertificateController]
    PUB --> SC[StreamController]

    ADM --> ADC[Admin Controllers]

    RC --> RS[RegistrationService]
    PC --> PS[PaymentService]
    ADC --> QS[QRService]
    ADC --> CS[CertificateService]
    ADC --> AS[AuditService]

    RS --> DB[(Database)]
    PS --> DB
    QS --> DB
    CS --> DB
    AS --> DB

    PS --> PAY[Paystack API]
    PAY --> PS
```

### 3.3 Request Flow Diagram (Registration to Certificate)
```mermaid
sequenceDiagram
    participant P as Participant
    participant R as RegistrationController
    participant S as RegistrationService
    participant Pay as PaymentController/Service
    participant Q as QRService
    participant C as CertificateService

    P->>R: POST /register
    R->>S: create registration + generate OTP
    S-->>P: redirect OTP verify

    P->>R: POST /email/verify
    R-->>P: redirect payment page

    P->>Pay: POST /payment/initiate
    Pay->>Pay: call Paystack initialize
    Pay-->>P: checkout_url

    Note over Pay: webhook/callback verification marks payment success and issues ticket token

    P->>Q: Present ticket at accreditation
    Q->>Q: validate token + log scan

    P->>C: POST /certificate/download
    C->>C: eligibility check / issue / render PDF
    C-->>P: certificate PDF
```

### 3.4 Security Architecture
- Route guards:
  - public throttles (`register`, OTP verify/resend, certificate verify, webhook)
  - admin group middleware: `auth`, `verified`, `EnsureAdminMfa`, `role:*`, `LogAdminRouteAccess`
- Payment trust model:
  - webhook signature validation + provider verification
  - callback verification fallback
- Access control:
  - role-restricted admin endpoints by function (finance, registration, accreditation, super admin)
- Input hardening:
  - per-controller request validation
  - file upload type/size constraints
- Auditability:
  - explicit logging for settings, certificate issuance/revoke, speaker/sponsor/user actions, admin route access

## 4) Data Model (Implemented/Used)
Core entities:
- `users`: login accounts, role, optional profile photo
- `registrations`: participant profile, payment state, attendance state, ticket token, optional profile photo
- `payment_transactions`: payment provider refs, status, payload, amount/currency
- `certificates`: certificate identity, issuance/revocation status, metadata
- `system_settings`: key/value runtime config
- `audit_logs`: immutable activity records
- `sponsors`: public sponsor catalog with active/sort controls
- `speakers`: public speaker catalog with keynote flag, session metadata
- `qr_scans` / `check_ins`: accreditation and attendance tracking records

## 5) Configuration and Dynamic Date System
Central timeline configuration is implemented and consumed across controllers and views.

Source of truth:
- `app/Support/EventDates.php`

Managed keys:
- `registration_open_at`
- `early_bird_deadline_at`
- `registration_close_at`
- `event_start_at`
- `event_end_at`

Admin management:
- `GET/POST /admin/settings`
- `SettingsController` validates ordering constraints and seeds missing date keys

Current enforcement:
- registration submit blocked outside window (`RegistrationController@register`)
- payment initiation blocked outside window (`PaymentController@initiate`)
- register/payment UIs show window-state warnings and disable action buttons when closed
- admin dashboard exposes registration window KPI (phase + days-to-open/close)

## 6) Completed Implementation Summary

### 6.1 Registration + OTP
- registration flow with validation and pricing lock
- OTP verify and resend endpoints with throttling
- auth compatibility path for starter-kit tests

### 6.2 Payment + Verification
- Paystack initialization via API
- callback verification fallback
- webhook handler with signature guard and replay/idempotency controls
- refund initiation pipeline in finance admin

### 6.3 Ticketing and QR Accreditation
- ticket token issuance and ticket views (web + PDF)
- QR validation normalization supports raw token, URL, and JSON token payload
- scanner responses support JSON/fetch integration
- offline cache/sync paths for accreditation operations

### 6.4 Attendance + Stream
- stream access gated by valid token and paid status
- heartbeat/progress endpoints for attendance accumulation

### 6.5 Certificate Lifecycle
- eligibility checks by attendance state/time
- issuance (automatic/manual forced), revocation, public verification
- PDF generation with landscape rendering controls
- explicit audit metadata for manual issue path

### 6.6 Admin Platform
- dashboard KPIs (registration, payments, attendance, conversion, registration-window state)
- registrations browse/edit/export
- finance browse/refund/export (CSV/PDF)
- certificates browse/issue/revoke/export (CSV/PDF)
- settings and stream configuration
- users and role management
- sponsors CRUD with logo upload
- speakers CRUD + bulk actions with upload support
- centralized audit views + export

### 6.7 Profile and Media
- profile photo support for users and registrations
- photo surfaces integrated in admin and participant experiences
- storage via `public` disk (`storage:link` required)

## 7) API-by-Module Reference

Conventions:
- base URL omitted
- middleware listed only when critical
- admin routes are under `/admin` and require admin middleware stack

### 7.1 Public Pages Module
- `GET /` -> `home` view with active sponsors
- `GET /pricing` -> pricing page
- `GET /about` -> about page
- `GET /programme` -> programme page
- `GET /venue` -> venue page
- `GET /faqs` -> FAQ page
- `GET /contact` -> contact page
- `GET /terms` -> terms/privacy page
- `GET /sponsors` -> public sponsors page
- `GET /speakers` -> public speakers page (keynote + invited partitions)

### 7.2 Authentication/Session Module
- `GET /signin` -> redirect `/login`
- `GET /auth/login` -> redirect `/login`
- `GET /logout` -> session logout (auth required)
- `GET /dashboard` -> participant dashboard (`auth`, `verified`)
- settings routes loaded from `routes/settings.php`

### 7.3 Registration Module
- `GET /register` -> show registration form
- `POST /register` -> create registration (`throttle:register`)
- `GET /email/verify/{registrationId}` -> show OTP form
- `POST /email/verify` -> verify OTP (`throttle:verify-otp`)
- `POST /email/verify/resend` -> resend OTP (`throttle:verify-otp-resend`)
- `GET /registration-status` -> participant status dashboard (`auth`, `verified`)

Runtime rules:
- registration submission is blocked if outside configured registration window

### 7.4 Payment Module
- `GET /payment?registrationId={id}` -> show payment summary page
- `POST /payment/initiate` -> initialize Paystack checkout
- `GET /payment/callback?reference={ref}` -> callback handling and fallback verification
- `POST /paystack/webhook` -> provider webhook (`VerifyPaystackSignature`, `throttle:paystack-webhook`)

Runtime rules:
- payment initiation is blocked if outside configured registration window

### 7.5 Ticket Module
- `GET /ticket/{token}` -> show accreditation ticket
- `POST /ticket/download-pdf` -> ticket PDF download

### 7.6 Stream/Attendance Module
- `GET /stream` -> stream access page (token gated)
- `GET /stream/progress` -> participant stream progress page
- `POST /stream/start` -> start attendance session
- `POST /stream/heartbeat` -> attendance heartbeat update
- `POST /stream/end` -> end session
- `POST /stream/progress` -> progress payload update

### 7.7 Certificate Module
- `GET /certificate?token={ticket_token}` -> participant certificate view
- `POST /certificate/download` -> certificate PDF download
- `GET /verify` -> certificate lookup form
- `GET /verify/{certificateId}` -> public certificate verification (`throttle:certificate-verify`)

### 7.8 QR Scanner Utility Module
- `GET /qr/scanner` -> utility scanner UI
- `POST /qr/process` -> scanner processing endpoint (check-in/verify/ticket/registration purposes)

### 7.9 Admin Dashboard Module
- `GET /admin/dashboard` -> operational KPIs and charts

### 7.10 Admin Registrations Module
- `GET /admin/registrations` -> list/filter registrations
- `GET /admin/registrations/export` -> export registrations
- `GET /admin/registrations/{id}` -> registration details
- `PUT /admin/registrations/{id}` -> update registration

### 7.11 Admin Finance Module
- `GET /admin/finance` -> list/filter transactions
- `POST /admin/finance/refund/{id}` -> initiate refund
- `GET /admin/finance/export` -> export CSV/PDF

### 7.12 Admin Accreditation Module
- `GET /admin/accreditation` -> scanner page
- `POST /admin/accreditation/scan` -> validate/log scan
- `GET /admin/accreditation/offline-cache` -> offline cache payload
- `POST /admin/accreditation/sync-cache` -> offline scan sync

### 7.13 Admin Audit Module
- `GET /admin/audit` -> audit listing
- `GET /admin/audit/export` -> audit export
- `GET /admin/audit-trail/{entityType}/{entityId}` -> entity audit trail (JSON)
- `GET /admin/audit/{auditLog}` -> audit details

### 7.14 Admin Stream Settings Module
- `GET /admin/stream` -> stream config form
- `POST /admin/stream` -> update stream config

### 7.15 Admin Certificates Module
- `GET /admin/certificates` -> list certificates
- `POST /admin/certificates/generate-batch` -> batch issue eligible certificates
- `POST /admin/certificates/issue` -> force/manual issue
- `POST /admin/certificates/{certificate}/revoke` -> revoke certificate
- `GET /admin/certificates/export` -> export CSV/PDF

### 7.16 Admin Pricing Module
- `GET /admin/pricing` -> pricing management screen
- `POST /admin/pricing/versions` -> create version
- `PUT /admin/pricing/versions/{version}` -> update version
- `DELETE /admin/pricing/versions/{version}` -> delete version
- `POST /admin/pricing/items` -> create item
- `PUT /admin/pricing/items/{item}` -> update item
- `DELETE /admin/pricing/items/{item}` -> delete item

### 7.17 Admin Users Module
- `GET /admin/users` -> users listing
- `GET /admin/users/{user}` -> user details
- `POST /admin/users` -> create admin user
- `PUT /admin/users/{user}/role` -> update role

### 7.18 Admin Settings Module
- `GET /admin/settings` -> system settings
- `POST /admin/settings` -> update settings

### 7.19 Admin Account Module
- `GET /admin/account/profile` -> profile page
- `PATCH /admin/account/profile` -> update profile
- `GET /admin/account/password` -> password page
- `PATCH /admin/account/password` -> update password

### 7.20 Admin Sponsors Module
- `GET /admin/sponsors` -> sponsors listing
- `POST /admin/sponsors` -> create sponsor
- `PUT /admin/sponsors/{sponsor}` -> update sponsor
- `DELETE /admin/sponsors/{sponsor}` -> delete sponsor

### 7.21 Admin Speakers Module
- `GET /admin/speakers` -> speakers listing
- `GET /admin/speakers/create` -> create form
- `POST /admin/speakers` -> create speaker
- `GET /admin/speakers/{speaker}/edit` -> edit form
- `PUT /admin/speakers/{speaker}` -> update speaker
- `DELETE /admin/speakers/{speaker}` -> delete speaker
- `POST /admin/speakers/bulk` -> bulk activate/deactivate/delete

## 8) Services and Cross-Cutting Components
- `RegistrationService`: registration persistence, OTP lifecycle
- `PaymentService`: webhook handling, provider verification, refund orchestration
- `QRService`: token normalization/validation, scan logging, scan result shaping
- `CertificateService`: eligibility checks, issue/revoke workflows, PDF rendering
- `AuditService`: standardized audit event writes
- `EventDates`: centralized timeline logic consumed by controllers and views

## 9) Storage and Files
User-uploaded/public assets:
- profile photos: `storage/app/public/profile-photos`
- sponsor logos: `storage/app/public/sponsors`
- speaker photos: `storage/app/public/speakers`

Deployment prerequisite:
- run `php artisan storage:link`

## 10) Testing Status and Gaps
Most implemented features are covered by feature tests and previously passing suite snapshots. Current shell cannot execute full suite due local PHP version mismatch (`8.3.x` vs project minimum `>=8.4`).

High-value test additions still recommended:
1. registration window edge times (open boundary, close boundary, closed state)
2. payment initiation closed-window behavior (JSON + UI)
3. certificate issue/revoke audit metadata assertions
4. speakers bulk action authorization and audit assertions

## 11) Operational Notes
- Audit table and settings table are guarded with `Schema::hasTable(...)` checks in relevant controllers for resilience during migration drift.
- Dynamic date settings now drive both behavior and public display text.
- Admin route access is explicitly logged for governance and forensic review.
